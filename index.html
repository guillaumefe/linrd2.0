
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Linrd</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="styles.css" />
    
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
      }
      .wrapper {
        display: flex;
        height: calc(100% - 56px);
      }
      #editor {
        flex: 1;
      }
      #viewer {
        flex: 1;
        padding: 10px;
        overflow-y: scroll;
        /* border-left: 1px solid #ccc; */
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 1% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }
      #popup-editor {
        min-height: 300px; /* ou une autre valeur qui convient */
      }
      .task {
          background-color: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 4px;
          padding: 15px;
          margin-bottom: 10px;
        }
      .task-title {
          margin-bottom: 5px;
        }
      .task-status,
      .task-id, .task-time {
          margin-bottom: 0;
          font-size: 0.9em;
        }
      .task-list {
          margin-top: 10px;
        }
.dark-blue {
  background-color: #0d47a1;
  color: white;
}

.button {
  font-size: 14px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin: 4px;
}

.button:disabled {
  background-color: #cccccc; /* Couleur d'arri√®re-plan pour les boutons d√©sactiv√©s */
  color: #999999; /* Couleur du texte pour les boutons d√©sactiv√©s */
  cursor: not-allowed; /* Change le curseur pour indiquer que le bouton est d√©sactiv√© */
}

.red {
  background-color: #f44336;
  color: white;
}

.green {
  background-color: #4CAF50;
  color: white;
}

.blue {
  background-color: #2196F3;
  color: white;
}

.yellow {
  background-color: #FFEB3B;
  color: black;
}
.description-container {
  font-family: 'Courier New', monospace;
  font-weight: normal;
  display: none;
  font-size:12px;
  margin-top: 3%;
}

.description-container h5 {
  margin: 0;
  line-height: 0;
}
.popup-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: rgba(0, 0, 0, 0.4);
}
.popup-container {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000; /* Assurez-vous que le popup est plac√© au-dessus de l'overlay */
}


.popup-content {
  background-color: white;
  padding: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.close-button {
  margin-top: 10px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  background-color: #ccc;
  color: #fff;
  cursor: pointer;
}
input[type="date"] {
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 10px;
}

input[type="number"] {
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 10px;
}
input.disabled {
  background-color: #f8f8f8;
  cursor: not-allowed;
}
.popup-content {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}


.input-container {
  display: flex;
  flex-direction: column;
  width: 100%;
}
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.5); /* Couleur blanche avec 50% d'opacit√© */
  z-index: 999; /* Assurez-vous que l'overlay est plac√© au-dessus des autres √©l√©ments */
}
.landing-page {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 255, 1);
  z-index: 1000;
}

.question {
  font-size: 18px;
  margin-bottom: 10px;
  color: white;
}

.task-input {
  font-size: 16px;
  background: transparent;
  border: none;
  outline: none;
  color: white;
  width: 100%;
  text-align: center;
}

.task-input::placeholder {
  color: white;
}

.project {
  background-color: #e0e0e0;
  display:none;
}

.simple-task {
  background-color: #f9f9f9;
}
.task-text {
  cursor: pointer;
}

.task-text:hover {
  font-weight: bold;
}
.search-container {
  margin-bottom: 10px;
  width: 100%;
}

.search-input {
  display:none;
  width: 100%;
  padding: 5px 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 14px;
}
.empty-inbox-message {
  text-align: center;
  padding: 20px;
}

.smiling-face {
  font-size: 48px;
}

.empty-inbox-message h2 {
  margin-top: 10px;
  margin-bottom: 20px;
}

    </style>
  </head>
<body>
  <div id="landingPage" class="landing-page">
    <div class="question">Que souhaitez-vous faire aujourd'hui?</div>
    <input id="inputTask" class="task-input" type="text" autofocus />
  </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Linrd.ml</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdown"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              Configuration
            </a>
            
<div class="dropdown-menu" aria-labelledby="navbarDropdown">
  <button
    class="dropdown-item"
    onclick="toggleTheme()"
  >
    Switch light/dark terminal
  </button>
  <button
    class="dropdown-item"
    id="debugToggleButton"
    onclick="toggleDebugMode()"
  >
    Activer/d√©sasctiver le mode debug
  </button>
  <!-- Ajoutez ce bouton pour basculer entre les t√¢ches et les dossiers -->
  <button
    class="dropdown-item"
    id="toggleTasksAndFolders"
    onclick="toggleProjects()"
  >
    Basculer entre t√¢ches et projets
  </button>
</div>


          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a style="display:none" class="nav-link" href="#">Se connecter</a>
          </li>
        </ul>
      </div>
    </nav>
    <div class="wrapper">
      <div id="editor"></div>
      <div id="viewer" class="tab-content">
      <!-- Champ de recherche -->
<div class="search-container">
  <input
    type="text"
    id="search-input"
    class="search-input"
    placeholder="Search"
  />
</div>

        <!-- Ajout des onglets -->
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a
              class="nav-link"
              id="inbox-tab"
              data-toggle="tab"
              href="#inbox"
              >Inbox</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              id="done-tab"
              data-toggle="tab"
              href="#done"
              >Done</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              id="cancel-tab"
              data-toggle="tab"
              href="#cancel"
              >Cancel</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              id="await-tab"
              data-toggle="tab"
              href="#await"
              >Await</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              id="doc-tab"
              data-toggle="tab"
              href="#doc"
              >Doc</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              id="delay-tab"
              data-toggle="tab"
              href="#delay"
              >Delay</a
            >
          </li>
            <div id="modal" class="modal">
              <div class="modal-content">
                <h2>New Project</h2>
                <div id="popup-editor"></div>
                <div id="yaml-error" style="display:none;">
                  <h5>Erreur dans le contenu YAML :</h5>
                  <pre id="yaml-error-message" style="color:red;"></pre>
                </div>
                <div class="button-row">
                  <button onclick="validateYaml()" class="btn btn-success">
                    Valider
                  </button>
                  <button onclick="closeModal()" class="btn btn-danger">
                    Annuler
                  </button>
                </div>
              </div>
            </div>
        </ul>
        
        <!-- Contenu des onglets -->
        <div id="catalog" class="tab-content">
          <div
            class="tab-pane fade"
            id="inbox"
            role="tabpanel"
            aria-labelledby="inbox-tab"
          >
            <h3 style="float:left">Inbox</h3>
            <div id="empty-inbox-message" class="empty-inbox-message" style="display: none;">
              <span role="img" aria-label="smiling face" class="smiling-face">üòä</span>
              <h2>Tout va bien ! Il n'y a rien √† faire pour le moment.</h2>
              <p>Vous pouvez toujours cr√©er une nouvelle t√¢che en utilisant le bouton "Nouvelle t√¢che" en bas √† droite.</p>
              <p>Voici comment utiliser Linrd :</p>
              <ul>
                <li>Cr√©ez des t√¢ches et des projets en utilisant les boutons situ√©s en bas √† droite.</li>
                <li>Organisez les t√¢ches dans diff√©rentes colonnes en fonction de leur statut.</li>
                <li>Utilisez la fonction de recherche pour filtrer les t√¢ches par mots-cl√©s.</li>
                <li>Acc√©dez aux param√®tres pour personnaliser l'application selon vos pr√©f√©rences.</li>
              </ul>
            </div>
            <button onclick="openModal()" style="margin-top:5px;margin-left:5px;" class="btn btn-sm">New project 
              <i class="fas fa-plus"></i>
            </button>
            <div id="inbox-tasks"></div>
              <button id="loadMoreInbox" class="loadMore btn btn-sm" style="display:none;">More</button>
            </div>
            <div
              class="tab-pane fade"
              id="done"
              role="tabpanel"
              aria-labelledby="done-tab"
            >
              <h3>Done</h3>
              <div id="done-tasks"></div>
              <button id="loadMoreDone" class="loadMore btn btn-sm" style="display:none;">More</button>
              
            </div>

          <div
            class="tab-pane fade"
            id="cancel"
            role="tabpanel"
            aria-labelledby="cancel-tab"
          >
            <h3>Cancel</h3>
            <div id="cancel-tasks"></div>
            <button id="loadMoreCancel" class="loadMore btn btn-sm" style="display:none;">More</button>
          </div>
          <div
            class="tab-pane fade"
            id="await"
            role="tabpanel"
            aria-labelledby="await-tab"
          >
            <h3>Await</h3>
            <div id="await-tasks"></div>
            <button id="loadMoreAwait" class="loadMore btn btn-sm" style="display:none;">More</button>
          </div>
          <div
            class="tab-pane fade"
            id="doc"
            role="tabpanel"
            aria-labelledby="doc-tab"
          >
            <h3>Doc</h3>
            <div id="doc-tasks"></div>
            <button id="loadMoreDoc" class="loadMore btn btn-sm" style="display:none;">More</button>
          </div>
          <div
            class="tab-pane fade"
            id="delay"
            role="tabpanel"
            aria-labelledby="delay-tab"
          >
            <h3>Delay</h3>
            <div id="delay-tasks"></div>
            <button id="loadMoreDelay" class="loadMore btn btn-sm" style="display:none;">More</button>
          </div>
        </div>
      </div>
    </div>

<script>
let mainEditor = ace.edit("editor");
document.addEventListener("DOMContentLoaded", function () {
  const landingPage = document.getElementById("landingPage");
  const inputTask = document.getElementById("inputTask");

  if (!getCookie("firstVisit")) {
    setCookie("firstVisit", "visited", 365);
  } else {
    landingPage.style.display = "none";
  }

  inputTask.addEventListener("input", function () {
    const inputLength = inputTask.value.length;

    if (inputLength >= 2) {
      const intensity = 1 - (inputLength - 1) * 0.05;
      landingPage.style.backgroundColor = `rgba(0, 0, 255, ${intensity})`;

if (intensity <= 0) {
  // Supprime l'√©l√©ment de la page lorsque l'opacit√© atteint 0%
  landingPage.remove();

  // Utilisez setTimeout pour attendre un peu avant de mettre le focus sur l'√©diteur et de positionner le curseur
  setTimeout(() => {
    mainEditor.focus();
    mainEditor.gotoLine(1, Infinity, true);
  }, 50);
}
    }

    // Met √† jour la premi√®re ligne de l'√©diteur Ace avec le contenu de l'input
    const firstLineRange = mainEditor.session.getLine(0).length;
    mainEditor.session.replace({ start: { row: 0, column: 0 }, end: { row: 0, column: firstLineRange } }, inputTask.value);
  });

  inputTask.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      // Supprime l'√©l√©ment de la page lorsque l'utilisateur appuie sur Entr√©e
      mainEditor.focus();
      mainEditor.gotoLine(1, Infinity, true);
      landingPage.remove();
    }
  });

});

function setCookie(cname, cvalue, exdays) {
  const d = new Date();
  d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
  const expires = "expires=" + d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
  const name = cname + "=";
  const decodedCookie = decodeURIComponent(document.cookie);

  const ca = decodedCookie.split(";");
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === " ") {
      c = c.substring(1);
    }
    if (c.indexOf(name) === 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

</script>
<script>
function calculateTargetTimestamp(inputValue) {
  let targetTimestamp;
  const now = new Date();

  if (inputValue.includes("-")) { // Date format : yyyy-mm-dd
    targetTimestamp = new Date(inputValue).getTime();
  } else { // Duration format : number of minutes
    const minutes = parseInt(inputValue);
    const durationInMs = minutes * 60 * 1000;
    targetTimestamp = now.getTime() + durationInMs;
  }

  return targetTimestamp;
}
</script>

<script>
function handleCancelButtonClick(task) {
  updateTaskStatus(task, 'x-');
}

function handleDoneButtonClick(task) {
  updateTaskStatus(task, '--');
}

function handleDocButtonClick(task) {
  updateTaskStatus(task, '+-');
}

function handleAwaitConfirmButtonClick(task) {
  const dateInput = document.getElementById("dateInput");
  const durationInput = document.getElementById("durationInput");
  const inputValue = dateInput.value || new Date().getTime();
  
  task.delay = calculateTargetTimestamp(inputValue);
  
  updateTaskStatus(task, '&-');
  closePopup();
}

function updateTaskDelay(task, delayTimestamp) {
  const lines = mainEditor.session.doc.getAllLines();
  const taskLineIndex = parseInt(task.id || task.target.dataset.task_id) - 1;
  let taskLine = lines[taskLineIndex];
  
  // Supprimer le d√©lai existant, s'il en existe un
  taskLine = taskLine.replace(/delay:(\s*\d+)?/g, '').trimEnd();
  
  // Ajouter le nouveau d√©lai
  lines[taskLineIndex] = `${taskLine} (delay=${parseInt(delayTimestamp)})`;
  mainEditor.session.doc.setValue(lines.join("\n"));
}

function handleDelayConfirmButtonClick(task) {
  const dateInput = document.getElementById("dateInput");
  const durationInput = document.getElementById("durationInput");
  const inputValue = dateInput.value || durationInput.value;

  const delayTimestamp = calculateTargetTimestamp(inputValue);
  
  updateTaskDelay(task, delayTimestamp); // Ajoutez cette ligne
  updateTaskStatus(task, '*-');
  closePopup();
}


function handleAwaitButtonClick(task) {
  openPopup("Await", task);
}

function handleDelayButtonClick(task) {
  openPopup("Delay", task);
}

function handleDateInputClick() {
  const dateInput = document.getElementById("dateInput");
  const durationInput = document.getElementById("durationInput");

  dateInput.disabled = false;
  dateInput.classList.remove("disabled");
  durationInput.disabled = true;
  durationInput.classList.add("disabled");
}

function handleDurationInputClick() {
  const dateInput = document.getElementById("dateInput");
  const durationInput = document.getElementById("durationInput");

  dateInput.disabled = true;
  dateInput.classList.add("disabled");
  durationInput.disabled = false;
  durationInput.classList.remove("disabled");
}

function handleInputChange() {
  const dateInput = document.getElementById("dateInput");
  const durationInput = document.getElementById("durationInput");
  const delayButton = document.getElementById("delayButton");

  if (dateInput.value || durationInput.value) {
    delayButton.disabled = false;
  } else {
    delayButton.disabled = true;
  }
}

function openPopup(title, task) {

  const overlay = document.createElement("div");
  overlay.classList.add("overlay");

  const peopleLabel = document.createElement("label");
  peopleLabel.textContent = "Related People:";

  const peopleTextarea = document.createElement("textarea");
  peopleTextarea.id = "peopleTextarea";
  peopleTextarea.placeholder = "Enter the names of the related people, separated by commas";

  const popupContainer = document.createElement("div");
  popupContainer.id = "popupContainer";
  popupContainer.classList.add("popup-container");

  const popupContent = document.createElement("div");
  popupContent.classList.add("popup-content");

  const popupTitle = document.createElement("h2");
  popupTitle.textContent = title + " until :";

  const dateInput = document.createElement("input");
  dateInput.type = "date";
  dateInput.id = "dateInput";
  dateInput.addEventListener("click", handleDateInputClick);
  dateInput.addEventListener("change", handleInputChange); // Ajoute cet √©couteur d'√©v√©nements

  const durationInput = document.createElement("input");
  durationInput.type = "number";
  durationInput.id = "durationInput";
  durationInput.placeholder = "Duration (in minutes)";
  durationInput.addEventListener("click", handleDurationInputClick);
  durationInput.addEventListener("change", handleInputChange); // Ajoute cet √©couteur d'√©v√©nements

  const cancelButton = createButton('Cancel', 'red', closePopup)
  cancelButton.classList.add("cancel-button");
  cancelButton.textContent = "Cancel";

  const delayButton = createButton(title, (title === 'Delay') ? 'yellow' : 'blue', handleDelayConfirmButtonClick)
  delayButton.classList.add("delay-button");
  delayButton.textContent = title;
  delayButton.id = "delayButton"
  delayButton.dataset.task_id = task.id
  delayButton.disabled = true; // D√©sactive le bouton par d√©faut
  
  const inputContainer = document.createElement("div");
  inputContainer.classList.add("input-container");

  inputContainer.appendChild(dateInput);
  inputContainer.appendChild(durationInput);
  if (title === "Await") {
    inputContainer.appendChild(peopleLabel);
    inputContainer.appendChild(peopleTextarea);
  }

  popupContent.appendChild(popupTitle);
  popupContent.appendChild(inputContainer);
  popupContent.appendChild(delayButton);
  popupContent.appendChild(cancelButton);


  popupContainer.appendChild(popupContent);

  document.body.appendChild(overlay);
  document.body.appendChild(popupContainer);
}

function closePopup() {
  const popupContainer = document.getElementById("popupContainer");
  const overlay = document.querySelector(".overlay");
  document.body.removeChild(popupContainer);
  document.body.removeChild(overlay);
}

</script>
<script>
function cleanUpDescription(content) {
  content = content.trim();

  // Supprimer les attributs entre parenth√®ses
  content = content.replace(/\([^()]+\)/g, '');

  // Retirer les bullet points de liste du d√©but de la phrase
  content = content.replace(/^\s*[-*]*\s*/, '');

  // Retirer les ":" r√©siduels √† la fin de la description
  content = content.replace(/:\s*$/, '');

  // Retirer les symboles "--", "x-", "*-", "+-", et "&+"
  content = content.replace(/(-|x|\*|\+|&)-$/g, '');

  // Mettre en majuscule la premi√®re lettre de la description
  content = content.charAt(0).toUpperCase() + content.slice(1);

  // Mettre en majuscule tout caract√®re apr√®s un signe de ponctuation demandant une majuscule
  content = content.replace(/([.!?])\s*(\w)/g, (match, punctuation, letter) => {
    return punctuation + ' ' + letter.toUpperCase();
  });

  return content.trim(); // Supprimer les espaces suppl√©mentaires en d√©but et fin de la description
}

function cleanUpContext(context_array) {

  let i = 0;
  let result = "";
  for (; i <= context_array.length - 1; i++) {
    result += cleanUpDescription(context_array[i]);
    result += " > ";
  }
  return result.trimEnd().slice(0, -1);
}


</script>
<script>
  function getStatusSymbol(line) {
    const match = line.trimEnd().match(/(--|\+\-|&\-|x\-|\*-)$/);
    return match ? match[1] : null;
  }
  function getIndent(line) {
    return line.search(/\S|$/);
  }
  function getDescription(line) {
    return line.replace(/^\s*[\+\-\*]*\s*:\>?\s*/, '');
  }
  function isProject(line, index, lines) {
    const childrenRegex = /:\s*$/;
    const childTaskRegex = /^\s{2,}[\+\-\*]/;

    if (line.match(childrenRegex)) {
      const indent = getIndent(line);
      let nextLine = lines[index + 1];
      let hasChild = false;

      while (nextLine && getIndent(nextLine) > indent) {
        if (nextLine.match(childTaskRegex)) {
          hasChild = true;
          break;
        }
        index++;
        nextLine = lines[index + 1];
      }
      return hasChild;
    }
    return false;
  }
function getTaskDetails(line, taskId, index, lines) {
  const indent = getIndent(line);
  const statusSymbol = getStatusSymbol(line);
  let description = getDescription(line);
  const attributes = extractAttributes(description);

  const atimeMatch = attributes.atime ? attributes.atime.match(/\(ctime=(.*)\)$/) : null;
  let existingAtime = atimeMatch ? atimeMatch[1] : null;
  let atimeSet = false;

  if (!existingAtime) {
    const now = new Date().getTime();
    const timestamp = now;
    existingAtime = timestamp;
    atimeSet = true;
  }

  return {
    description: attributes.description || description,
    clean_description : cleanUpDescription(attributes.description || description),
    is_project:  isProject(line, index, lines),
    status: statusSymbol,
    context: [],
    indent,
    id: `${taskId}`,
    atime: existingAtime,
    attributes: attributes,
    clean_context: "",
    delay: attributes.delay || null,
  };
}


</script>
<script>
  function extractAttributes(description) {
    const attributes = {};
    const matches = description.match(/\(([a-z]+)=(.*?)\)/g);
    if (matches) {
      matches.forEach((match) => {
        const attributeMatch = match.match(/\(([a-z]+)=(.*?)\)/);
        if (attributeMatch && attributeMatch.length === 3) {
          const attributeName = attributeMatch[1];
          const attributeValue = attributeMatch[2];
          attributes[attributeName] = attributeValue;
        }
      });
    }
    return attributes;
  }
</script>
<script>
  function getParentTask(indent) {
    for (let i = contextStack.length - 1; i >= 0; i--) {
      if (contextStack[i].indent < indent) {
        return contextStack[i];
      }
    }
    return null;
  }
</script>
<script>
  function addTaskToTop(editor_source, editor_destination, yaml) {
    const cursorPosition = editor_destination.getCursorPosition();
    const cursorRow = cursorPosition.row;
    const cursorColumn = cursorPosition.column;
    const firstLine = editor_destination.session.getLine(0);
    editor_destination.session.insert({row: 0, column: 0}, `${yaml}\n`);
    editor_destination.gotoLine(cursorRow + 1, cursorColumn);
    editor_source.setValue("");
    editor_destination.resize();
  }


</script>
<script>
function parseYaml(yaml) {
  const lines = yaml.split("\n");
  const tasks = [];
  let taskId = 1;
  const contextStack = [];

  const isChildTask = (line, index) => {
    const indent = getIndent(line);
    const nextLine = lines[index + 1];
    return nextLine && getIndent(nextLine) > indent;
  };

  const getParentTask = (indent) => {
    for (let i = contextStack.length - 1; i >= 0; i--) {
      if (contextStack[i].indent < indent) {
        return contextStack[i];
      }
    }
    return null;
  };

  lines.forEach((line, index) => {
    if (line.trim() === '') {
      return;
    }

    const task = getTaskDetails(line, taskId, index, lines);
    const parentTask = getParentTask(task.indent);

    if (parentTask) {
      task.context = parentTask.context.slice();
      task.context.push(parentTask.id);
    }

    if (isChildTask(line, index)) {
      task.is_project = true;
    }

    tasks.push(task);
    taskId++;

    contextStack.push(task);
  });

  tasks.forEach((task) => {
    task.context = task.context.map((taskId) => {
      const matchingTask = tasks.find((t) => t.id === taskId);
      return matchingTask ? matchingTask.description : taskId;
    });
    task.clean_context = cleanUpContext(task.context); // Ajoutez cette ligne pour attribuer la valeur de clean_context
  });

  return tasks;
}
</script>
<script>
  function toggleTheme() {
    let theme = mainEditor.getTheme();
    let newTheme =
      theme === "ace/theme/monokai"
        ? "ace/theme/github"
        : "ace/theme/monokai";
    mainEditor.setTheme(newTheme);
    popupEditor.setTheme(newTheme);
  }
</script>
<script>
  function parseProjects(editorContent) {
    const lines = editorContent.split('\n');
    const projects = [];

    lines.forEach((line, index) => {
      if (isProject(line, index, lines)) {
        const description = line.replace(':', '').trim();
        projects.push({ description });
      }
    });

    return projects;
  }
</script>
<script>

  function loadData() {
    const data = localStorage.getItem("editor");
    const tasks = data ? JSON.parse(data) : [];
    let descriptions = tasks.map((task) => task.description).join("\n");
    return descriptions;
  }
  
  function saveData(data) {
    localStorage.setItem('editor', JSON.stringify(data));
  }
</script>
<script>
let maxTasksPerColumn = 20;
let inboxTotalTasks = 0;
let doneTotalTasks = 0;
let docTotalTasks = 0;
let awaitTotalTasks = 0;
let delayTotalTasks = 0;
let cancelTotalTasks = 0;
let inboxLoadedTasks = 0;
let doneLoadedTasks = 0;
let docLoadedTasks = 0;
let awaitLoadedTasks = 0;
let delayLoadedTasks = 0;
let cancelLoadedTasks = 0;
let inboxTasks = [];
let doneTasks = [];
let docTasks = [];
let awaitTasks = [];
let delayTasks = [];
let cancelTasks = [];


function updateLoadMoreButtonVisibility(columnId) {
  let totalTasks;
  let loadedTasks;

  switch (columnId) {
    case 'inbox':
      totalTasks = inboxTotalTasks;
      loadedTasks = inboxLoadedTasks;
      break;
    case 'done':
      totalTasks = doneTotalTasks;
      loadedTasks = doneLoadedTasks;
      break;
    case 'doc':
      totalTasks = docTotalTasks;
      loadedTasks = docLoadedTasks;
      break;
    case 'await':
      totalTasks = awaitTotalTasks;
      loadedTasks = awaitLoadedTasks;
      break;
    case 'delay':
      totalTasks = delayTotalTasks;
      loadedTasks = delayLoadedTasks;
      break;
    case 'cancel':
      totalTasks = cancelTotalTasks;
      loadedTasks = cancelLoadedTasks;
      break;
    default:
      return;
  }

  const remainingTasks = totalTasks - loadedTasks;
  const loadMoreButton = document.getElementById('loadMore' + columnId.charAt(0).toUpperCase() + columnId.slice(1));

  if (remainingTasks > 0) {
    loadMoreButton.style.display = 'block';
  } else {
    loadMoreButton.style.display = 'none';
  }
}

function loadMoreTasks(columnId) {
  let totalTasks;
  let loadedTasks;

  switch (columnId) {
    case 'inbox':
      totalTasks = inboxTotalTasks;
      loadedTasks = inboxLoadedTasks;
      inboxLoadedTasks += Math.min(20, totalTasks - loadedTasks);
      updateTab(columnId, inboxTasks.slice(0, inboxLoadedTasks));     
      break;
    case 'done':
      totalTasks = doneTotalTasks;
      loadedTasks = doneLoadedTasks;
      doneLoadedTasks += Math.min(20, totalTasks - loadedTasks);
      updateTab(columnId, doneTasks.slice(0, doneLoadedTasks));
      break;
    case 'doc':
      totalTasks = docTotalTasks;
      loadedTasks = docLoadedTasks;
      docLoadedTasks += Math.min(20, totalTasks - loadedTasks);
      updateTab(columnId, docTasks.slice(0, docLoadedTasks));
      break;
    case 'await':
      totalTasks = awaitTotalTasks;
      loadedTasks = awaitLoadedTasks;
      awaitLoadedTasks += Math.min(20, totalTasks - loadedTasks);
      updateTab(columnId, awaitTasks.slice(0, awaitLoadedTasks));
      break;
    case 'delay':
      totalTasks = delayTotalTasks;
      loadedTasks = delayLoadedTasks;
      delayLoadedTasks += Math.min(20, totalTasks - loadedTasks);
      updateTab(columnId, delayTasks.slice(0, delayLoadedTasks));
      break;
    case 'cancel':
      totalTasks = cancelTotalTasks;
      loadedTasks = cancelLoadedTasks;
      cancelLoadedTasks += Math.min(20, totalTasks - loadedTasks);
      updateTab(columnId, cancelTasks.slice(0, cancelLoadedTasks));
      break;
    default:
      return;
  }

  // V√©rifier si toutes les t√¢ches ont √©t√© charg√©es
  const remainingTasks = totalTasks - loadedTasks;
  if (remainingTasks > maxTasksPerColumn) {
    document.getElementById('loadMore' + columnId.charAt(0).toUpperCase() + columnId.slice(1)).style.display = 'none';
  }
  updateLoadMoreButtonVisibility(columnId);
}

document.getElementById('loadMoreInbox').addEventListener('click', () => loadMoreTasks('inbox'));
document.getElementById('loadMoreDone').addEventListener('click', () => loadMoreTasks('done'));
document.getElementById('loadMoreDoc').addEventListener('click', () => loadMoreTasks('doc'));
document.getElementById('loadMoreAwait').addEventListener('click', () => loadMoreTasks('await'));
document.getElementById('loadMoreDelay').addEventListener('click', () => loadMoreTasks('delay'));
document.getElementById('loadMoreCancel').addEventListener('click', () => loadMoreTasks('cancel'));

</script>
<script>
let showFolders = true;

function updateViewer(tasks) {
  inboxTasks = [];
  doneTasks = [];
  docTasks = [];
  awaitTasks = [];
  delayTasks = [];
  cancelTasks = [];

  tasks.forEach((task) => {
    switch (task.status) {
      case '--':
        doneTasks.push(task);
        break;
      case '+-':
        docTasks.push(task);
        break;
      case '&-':
        awaitTasks.push(task);
        break;
      case 'x-':
        cancelTasks.push(task);
        break;
      case '*-':
        delayTasks.push(task);
        break;
      default:
        inboxTasks.push(task);
        break;
    }
  });

  inboxTotalTasks = inboxTasks.length;
  doneTotalTasks = doneTasks.length;
  docTotalTasks = docTasks.length;
  awaitTotalTasks = awaitTasks.length;
  delayTotalTasks = delayTasks.length;
  cancelTotalTasks = cancelTasks.length;

  updateTab('inbox', inboxTasks.slice(0, maxTasksPerColumn));
  updateTab('done', doneTasks.slice(0, maxTasksPerColumn));
  updateTab('doc', docTasks.slice(0, maxTasksPerColumn));
  updateTab('cancel', cancelTasks.slice(0, maxTasksPerColumn));

  // Tri des t√¢ches Delay et Await par attribut `delay`
  delayTasks.sort(compareTasksByDelay);
  awaitTasks.sort(compareTasksByDelay);

  // Mettez √† jour les colonnes Delay et Await avec les nouvelles donn√©es tri√©es
  updateTab('delay', delayTasks.slice(0, maxTasksPerColumn));
  updateTab('await', awaitTasks.slice(0, maxTasksPerColumn));
  
  ['inbox', 'done', 'doc', 'await', 'delay', 'cancel'].forEach(columnId => {
    updateLoadMoreButtonVisibility(columnId);
  });
  
  // Sauvegardez les donn√©es mises √† jour
  saveData([...inboxTasks, ...doneTasks, ...docTasks, ...awaitTasks, ...delayTasks, ...cancelTasks]);
  //saveData(tasks);
}

// Fonction de comparaison pour trier par attribut `delay`
function compareTasksByDelay(a, b) {
  if (a.delay < b.delay) {
    return -1;
  } else if (a.delay > b.delay) {
    return 1;
  } else {
    return 0;
  }
}

function addTimestampAttributes(task) {
  const now = new Date().getTime();
  const attributes = [];

  if (task.atime !== null && task.atime !== undefined) {
    attributes.push(`(ctime=${task.atime})`);
  }

  if (task.mtime !== null && task.mtime !== undefined) {
    attributes.push(`(mtime=${task.mtime})`);
  }

  if (attributes.length > 0) {
    const attributeString = attributes.join('');
    task.description = `${task.description}${attributeString}`;
  }

  return task;
}




function generateTasks(editorContent) {
  if (!editorContent) {
    return [];
  }

  let tasks;
  let projects;

  try {
    tasks = parseYaml(editorContent);
    projects = parseProjects(editorContent);
    updateViewer(tasks);
  } catch (e) {
    console.error("Erreur lors du chargement du contenu de l'√©diteur :", e);
    return [];
  }

  return tasks.map(task => {
    task.description = task.description.trimEnd();

    if (task.description.includes("(ctime=")) {
      return task;
    } else {
      const now = new Date().getTime();
      const atime = ` (ctime=${now})`;
      const attributes = [];

      if (task.attributes.mtime !== null && task.attributes.mtime !== undefined) {
        attributes.push(`mtime=${task.attributes.mtime}`);
      }
      // ctime is taken from atime
      if (task.attributes.atime !== null && task.attributes.atime !== undefined) {
        attributes.push(`ctime=${task.attributes.atime}`);
      }

      const attributesString = attributes.length > 0 ? `(${attributes.join(",")})` : "";
      const description = task.description + (attributesString ? " " : "") + attributesString + atime;

      if (projects.some(project => project.description === description)) {
        task.description = description + ":";
      } else {
        task.description = description;
      }

      return task;
    }
  });
}

</script>
<script>
// Fonction pour mettre √† jour l'√©diteur
function updateEditor() {
  const editor = ace.edit("editor");
  const session = editor.getSession();
  const cursor = editor.selection.getCursor();

  // R√©cup√©rer la ligne actuelle
  const currentRow = cursor.row;
  const currentLine = session.getLine(currentRow);

  // V√©rifier si la ligne est une t√¢che de plus de 1 caract√®re
  if (currentLine.trim().length >= 1) {
    const indent = currentLine.match(/^\s*/)[0]; // R√©cup√©rer l'indentation de la ligne

    // V√©rifier si la ligne commence d√©j√† par "(ctime="
    if (!currentLine.trim().startsWith("(ctime=")) {
      // Ins√©rer "(ctime=__timestamp__) " au d√©but de la ligne
      const newTimestamp = `(ctime=${new Date().getTime()}) `;
      const updatedLine = `${indent}${newTimestamp}${currentLine.trim()}`;

      // R√©cup√©rer la position actuelle du curseur
      const currentColumn = cursor.column;

      // Ins√©rer le texte mis √† jour dans l'√©diteur
      session.replace({ start: { row: currentRow, column: 0 }, end: { row: currentRow, column: currentLine.length } }, updatedLine);

      // Calculer la nouvelle position du curseur
      const newColumn = currentColumn + newTimestamp.length;

      // D√©placer le curseur √† la nouvelle position
      editor.selection.moveCursorTo(currentRow, newColumn, true);
    }
  }
}

// √âv√©nement de modification du contenu de l'√©diteur
mainEditor.session.on("change", updateEditor);

</script>

<script>
  const initialData = loadData();
  mainEditor.session.insert({ row: 0, column: 0 }, initialData);
  
  let popupEditor;

  function initPopupEditor() {
    popupEditor = ace.edit("popup-editor");
    popupEditor.setTheme("ace/theme/github");
    popupEditor.session.setMode("ace/mode/yaml");
  }
  
function updateTaskStatus(task, newStatusSymbol) {
  const lines = mainEditor.session.doc.getAllLines();
  const taskLineIndex = parseInt(task.id || task.target.dataset.task_id) - 1;
  let taskLine = lines[taskLineIndex];
  const currentStatusSymbol = getStatusSymbol(taskLine);
  
  // Supprimer tous les symboles de statut existants dans la description
  taskLine = taskLine.replace(/(-|\+|&|x|\*)-$/g, '').trimEnd();
  lines[taskLineIndex] = taskLine.replace(taskLine, `${taskLine} ${newStatusSymbol}`);
  mainEditor.session.doc.setValue(lines.join("\n"));
  
}

function highlightTaskLine(task) {
  const editor = ace.edit('editor');
  const lineNumber = task.id - 1;

  // D√©s√©lectionner toute s√©lection pr√©c√©dente
  editor.selection.clearSelection();

  // Mettre en √©vidence la ligne correspondante
  editor.selection.moveCursorToPosition({ row: lineNumber, column: 0 });
  editor.selection.selectLine();

  // Faites d√©filer l'√©diteur jusqu'√† la ligne en surbrillance
  editor.scrollToLine(lineNumber, true, true, () => {});
  editor.focus();
}



function createTaskElement(task) {

  // V√©rifier si la description de la t√¢che est vide ou compos√©e uniquement d'espaces
  if (!task.description || task.description.trim() === '') {
    return null;
  }

  const taskClass = task.is_project ? "project" : "simple-task";
  const taskElement = createDivWithClass('task');
  taskElement.classList.add(taskClass);
  
  if (!popupEditor) {
    initPopupEditor();
  } else {
    popupEditor.resize();
  }
  

  taskElement.appendChild(createButton('Cancel', 'red', () => handleCancelButtonClick(task)));
  taskElement.appendChild(createButton('Done', 'green', () => handleDoneButtonClick(task)));
  taskElement.appendChild(createButton('Await', 'blue', () => handleAwaitButtonClick(task)));
  taskElement.appendChild(createButton('Delay', 'yellow', () => handleDelayButtonClick(task)));
  taskElement.appendChild(createButton('Doc', 'dark-blue', () => handleDocButtonClick(task)));
  
  const taskTextElement = createTaskTextElement(task);  
  taskTextElement.className = 'task-text-action';
  taskTextElement.textContent = (task.clean_context) ? task.clean_context + " > " + task.clean_description : task.clean_description;
  taskTextElement.onclick = () => highlightTaskLine(task);
  taskElement.appendChild(taskTextElement);
  
  return taskElement;
}


function createDivWithClass(className) {
  const div = document.createElement('div');
  div.classList.add(className);
  return div;
}

function formatTimestamp(timestamp) {
  const date = new Date(timestamp);
  const year = date.getFullYear();
  const month = ("0" + (date.getMonth() + 1)).slice(-2);
  const day = ("0" + date.getDate()).slice(-2);
  return `${day}/${month}/${year}`;
}

function createTaskTextElement(task) {
  let context = createBoldGreyParagraphWithText(task.clean_context);
  let action = createParagraphWithText(task.clean_description);

  // Ajoute le timestamp du d√©lai s'il existe, se transforme en deadline
  if (task.delay) {
    const delayText = document.createElement("span");
    delayText.textContent = ` Deadline: ${formatTimestamp(parseInt(task.delay,10))}`;
    delayText.style.color = "grey";
    action.appendChild(delayText);
  }

  let container = createDivWithClass("action");
  container.appendChild(context);
  container.appendChild(action);

  // Ajoute les informations de d√©bogage si le mode debug est activ√©
  if (debugMode) {
    const debugInfo = document.createElement("pre");
    debugInfo.textContent = JSON.stringify(task, null, 2);
    debugInfo.style.fontSize = "0.8em";
    debugInfo.style.color = "grey";
    container.appendChild(debugInfo);
  }

  return container;
}


function updateAllTabs() {
  updateTab("inbox", inboxTasks.slice(0, inboxLoadedTasks));
  updateTab("done", doneTasks.slice(0, doneLoadedTasks));
  updateTab("cancel", cancelTasks.slice(0, cancelLoadedTasks));
  updateTab("await", awaitTasks.slice(0, awaitLoadedTasks));
  updateTab("doc", docTasks.slice(0, docLoadedTasks));
  updateTab("delay", delayTasks.slice(0, delayLoadedTasks));
}

function createButton(label, className, onClick) {
  const button = document.createElement('button');
  button.classList.add('button', className);
  button.textContent = label;
  button.addEventListener('click', onClick);
  return button;
}

function createSpanWithText(text) {
  const span = document.createElement('span');
  span.textContent = text;
  return span;
}

function createParagraphWithText(text) {
  const paragraph = document.createElement('p');
  paragraph.textContent = text;
  return paragraph;
}

function createBoldGreyParagraphWithText(text) {
  const paragraph = document.createElement('p');
  const boldText = document.createElement('strong');
  boldText.textContent = text;
  paragraph.appendChild(boldText);
  paragraph.style.color = 'grey';
  return paragraph;
}


</script>
<script>
  function updateTab(tabId, tasks) {
    const tab = document.getElementById(tabId);
    if (!tab) {
      console.error('Tab not found:', tabId);
      return;
    }

    const taskList = document.createElement('div');
    taskList.classList.add("task-list");
    tasks.forEach((task) => {
      const taskElement = createTaskElement(task);
      taskList.appendChild(taskElement);
    });

    const tabTasks = document.getElementById(tabId + '-tasks');
    tabTasks.innerHTML = '';
    if (tabId === 'inbox') {
      const emptyInboxMessage = document.getElementById('empty-inbox-message');
      if (tasks.length === 0) {
        emptyInboxMessage.style.display = 'block';
      } else {
        emptyInboxMessage.style.display = 'none';
      }
    }

    tabTasks.appendChild(taskList);
  }
</script>
<script>
  mainEditor.session.on("change", () => {
    const content = mainEditor.getValue();
    const tasks = generateTasks(content);
    //updateViewer(tasks);
  });
</script>
<script>
  function openModal() {
    document.getElementById("modal").style.display = "block";
    if (!popupEditor) {
      initPopupEditor();
    } else {
      popupEditor.resize();
    }
  }

  function closeModal() {
    document.getElementById("modal").style.display = "none";
  }

  function validateYaml() {
    let content = popupEditor.getValue();
    try {
      addTaskToTop(popupEditor, mainEditor, content);
      closeModal();
      document.getElementById("yaml-error").style.display = "none";
    } catch (e) {
      document.getElementById("yaml-error-message").innerText = e.message;
      document.getElementById("yaml-error").style.display = "block";
    }
  }
</script>
<script>
// Assurez-vous que Ace est charg√© avant d'appeler cette fonction.
function addAndRemoveLine() {
  const mainEditor = ace.edit('editor'); // Remplacez 'mainEditor' par l'ID de l'√©l√©ment contenant votre √©diteur Ace
  const session = mainEditor.getSession();
  const linesCount = session.getLength();
  
  // Ajouter une nouvelle ligne √† la fin
  session.insert({ row: linesCount, column: 0 }, '\n');
  
  // Supprimer la nouvelle ligne apr√®s un certain temps
  setTimeout(() => {
    const newLinesCount = session.getLength();
    session.remove({ start: { row: newLinesCount - 1, column: 0 }, end: { row: newLinesCount, column: 0 } });
  }, 1); // Le d√©lai avant de supprimer la ligne. Ici, il est d√©fini sur 3000 millisecondes (3 secondes).
}

// S'assurer que la page est compl√®tement charg√©e
window.onload = function() {
  // Assurez-vous que Ace est compl√®tement charg√©
  ace.require(['ace/ace'], function(ace) {
    // Ajouter et retirer la ligne une fois que tout est pr√™t
    addAndRemoveLine();
  });
};

</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // S√©lectionnez l'onglet que vous souhaitez cliquer programmation.
  var onglet = document.getElementById('inbox-tab');

  // D√©clencher le clic sur l'onglet
  var event = new MouseEvent('click', {
    view: window,
    bubbles: true,
    cancelable: true
  });
  onglet.dispatchEvent(event);
});
</script>
<script>
  let debugMode = false;

  function toggleDebugMode() {
    debugMode = !debugMode;
    const debugToggleButton = document.getElementById('debugToggleButton');
    if (debugMode) {
      debugToggleButton.textContent = "D√©sactiver le mode debug";
    } else {
      debugToggleButton.textContent = "Activer le mode debug";
    }
    updateAllTabs();
  }
</script>

<script>
function updateDelayTasksStatus() {
  const now = new Date().getTime();
  const tommorrow = new Date(now + (24 * 60 * 60 * 1000)); // Ajourz un jour en millisecondes

  let tasksUpdated = false;
  const editor = ace.edit("editor");
  const session = editor.getSession();
  
  for (let i = 0; i < delayTasks.length; i++) {
    const delayDate = delayTasks[i].delay; 
    
    if (delayDate && delayDate <= tommorrow) {
      const taskDescription = delayTasks[i].description;
      const taskRegExp = new RegExp(`^\\s*${taskDescription.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*[-+&x*]?`, 'm');
      const match = session.getValue().match(taskRegExp);
      
      if (match) {
        const lineNumber = session.getValue().substring(0, match.index).split('\n').length - 1;
        const lineContent = session.getLine(lineNumber);
        const updatedLine = lineContent.replace(/[-+&x*]{1,2}/g, '');
        
        // Mettre √† jour le statut de la t√¢che dans delayTasks
        delayTasks[i].status = null;
        tasksUpdated = true;
        
        // Mettre √† jour la ligne dans l'√©diteur
        session.replace({ start: { row: lineNumber, column: 0 }, end: { row: lineNumber, column: lineContent.length } }, updatedLine);

      }
    }
  }

  if (tasksUpdated) {
    // Mettre √† jour les colonnes avec les nouvelles donn√©es
    updateTab('delay', delayTasks.slice(0, maxTasksPerColumn));
    saveData([...inboxTasks, ...doneTasks, ...docTasks, ...awaitTasks, ...delayTasks, ...cancelTasks]);
  }
}

// Appeler la fonction updateDelayTasksStatus toutes les 60 secondes (60000 ms)
setInterval(updateDelayTasksStatus, 6000);

</script>

  </body>
</html>
